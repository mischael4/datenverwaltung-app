<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DatenPilot - BLK – Tätigkeiten & Fahrten einfach verwalten</title>
<meta name="author" content="Michael Gibbels">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#27ae60">

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Excel/CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root { --brand:#27ae60; --brand-d:#1f8a4e; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:20px; background:#f9f9f9; color:#222; }
h2 { font-size:22px; color:var(--brand); margin-bottom:10px; }
h4 { font-size:16px; color:#333; margin-bottom:15px; }
.container { display:flex; flex-direction:column; gap:20px; max-width:1200px; margin:auto; }
.form-container, .table-container { background:white; border:1px solid #ddd; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.form-group { margin-bottom:15px; }
label { display:block; margin-bottom:5px; font-weight:600; color:#555; }
label .hint { font-size:12px; font-weight:normal; color:#999; display:block; margin-top:2px; }
input,textarea,select { width:100%; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; background:#fafafa; transition: all 0.2s; }
input:focus, textarea:focus, select:focus { border-color:var(--brand); outline:none; background:white; }

button { background:var(--brand); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-size:16px; transition: all 0.2s; width:100%; display:block; margin-bottom:10px; }
button:hover { background:var(--brand-d); }
button.cancel-btn { background:#e74c3c; }
button.cancel-btn:hover { background:#c0392b; }
button.data-btn { background:#7f8c8d; }
button.data-btn:hover { background:#636e72; }

table { width:100%; border-collapse:collapse; margin-top:20px; font-size:14px; }
th,td { border:1px solid #eee; padding:10px; text-align:left; vertical-align:top; }
th { background:#f1f1f1; font-weight:600; color:#333; }
tr:nth-child(even){ background:#fcfcfc; }
.tatigkeit-cell { font-size: 14px; white-space: normal; word-break: break-word; line-height: 1.4; }
.summary { margin-top:10px; margin-bottom:15px; font-weight:bold; text-align:right; color:#444; font-size:13px; }
.edit-btn { background:#f39c12; padding:4px 6px; font-size:12px; margin-bottom:4px; width:99%; }
.edit-btn:hover { background:#d68910; }
.delete-btn { background:#e74c3c; padding:4px 6px; font-size:12px; margin-bottom:4px; width:99%; }
.delete-btn:hover { background:#c0392b; }
.copy-btn { background:#2980b9; padding:4px 6px; font-size:12px; width:99%; }
.copy-btn:hover { background:#21618c; }
.modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:25px; border:1px solid #ccc; border-radius:12px; z-index:1000; width:min(700px,90vw); max-height:90vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 900; }
.modal.active, .modal-overlay.active { display: block; }

@media (max-width:768px) {
  body { margin:10px; font-size:16px; }
  .form-container, .table-container { padding:15px; }
  input,textarea,button { font-size:16px; }
  button { width:100%; padding:14px; font-size:18px; }
  .table-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 2px; box-sizing: border-box; }
  .table-scroll table { width: max-content; min-width: 100%; table-layout: auto; border-collapse: collapse; }
}
@media (max-width:480px) {
  .edit-btn, .delete-btn, .copy-btn { font-size: 10px !important; padding: 4px 6px !important; margin-bottom: 2px !important; width: 100%; box-sizing: border-box; }
}

#tatigkeit { height:180px; font-size:13px; line-height:1.4; padding:6px; border-radius:6px; }
#tatigkeit option { padding:4px 6px; border-bottom:1px solid #eee; }
#tatigkeit option:last-child { border-bottom:none; }
#searchInput { margin-top:10px; padding:8px; border:1px solid #ccc; border-radius:6px; }

/* Spezieller Stil für den "Datensatz hinzufügen"-Button */
#submitBtn {
  background: #27ae60;           /* kräftiges Grün als Füllfarbe */
  border: 2px solid #1f8a4e;    /* dunklerer Rahmen */
  color: white;                  /* Schriftfarbe kontrastreich */
  font-weight: 600;
  border-radius: 8px;
  padding: 14px 12px;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.2s ease;
}

#submitBtn:hover {
  background: #1f8a4e;           /* noch dunkleres Grün beim Hover */
  transform: translateY(-2px);   /* leichter Lift-Effekt */
}

</style>
</head>

<body>
<div id="modalOverlay" class="modal-overlay"></div>
<div class="container">
<h2>DatenPilot - BLK Köln</h2>

<div class="form-container">
<h4 id="erfassen">Neue Tätigkeit hinzufügen</h4>
<form id="dataForm">
<div class="form-group"><label for="datum">Datum:</label><input type="date" id="datum" required></div>
<div class="form-group"><label for="name">Name:</label><input type="text" id="name" required></div>
<div class="form-group"><label for="schule">Ort der Beschulung/ Besprechung:</label><input type="text" id="schule" required></div>
<div class="form-group">
<label for="tatigkeit">Unterstützungsmaßnahmen <span class="hint">(Mehrfachauswahl mit STRG/CMD)</span></label>
<select id="tatigkeit" multiple required>
<option>Förderunterricht</option>
<option>Anmeldung durchreisender SchülerInnen an örtlichen Stammschulen</option>
<option>Beratung von Bereichslehrkräften</option>
<option>Beratung einer Stamm- oder Stützpunktschule</option>
<option>Beratung von Eltern, Kindern und Schulen</option>
<option>Beratung von Lehrkräften</option>
<option>Beratung zur schulischen Perspektive</option>
<option>Datenerfassung DigLu - Anmeldung, Aktualisierung, Pflege und Registrierung</option>
<option>Dienstbesprechung bei der Bezirksregierung</option>
<option>Dienstbesprechung</option>
<option>Dokumentation</option>
<option>Entwicklung und Mitwirkung an innovativen Unterrichtsverfahren</option>
<option>geregelte Übergabe von SchülerInnen an andere Schulen und Bereichslehrkräfte</option>
<option>Herstellung von Kontakten zwischen Eltern und Schulen</option>
<option>Kontrolle der Lernstandsberichte, Einträge Schultagebuch (DigLu)</option>
<option>Organisation von Medien und Unterrichtsmaterialien für den Online-Unterricht</option>
<option>Organisation von Medien und Unterrichtsmaterialien für die Reise</option>
<option>Sammlung und Entwicklung von Unterrichtsmaterial</option>
<option>Sprechstundenbereitschaft</option>
<option>Teilnahme an der BuFo für BLK</option>
<option>Teilnahme BLK Landestreffen</option>
<option>terminliche Koordination</option>
<option>Unterstützung von SchülerInnen bei der Vorbereitung auf zentrale Prüfungen</option>
<option>Vorbereitung der Stützpunktschulen auf den Schulbesuch</option>
<option>besondere Koordinatorentätigkeiten</option>
<option>sonstiges</option>
<option>erkrankt</option>
</select>
</div>
<div class="form-group"><label for="anmerkungen">Anmerkungen:</label><textarea id="anmerkungen" rows="3"></textarea></div>
<div class="form-group"><label for="strecke">Strecke:</label><input type="text" id="strecke"></div>
<div class="form-group"><label for="zeit">Zeit (h):</label><input type="number" id="zeit" step="0.01" min="0" required></div>
<div class="form-group"><label for="km">Kilometer (km):</label><input type="number" id="km" step="0.1" min="0" required></div>
<button type="submit" id="submitBtn">Datensatz hinzufügen</button>
</form>
</div>

<div class="table-container">
<h2 id="daten">Übersicht Tätigkeiten - Gespeicherte Datensätze</h2>
<input type="text" id="searchInput" placeholder="Suche nach Text..." />
<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th id="sortDateHeader" style="cursor:pointer">Datum ↑</th>
        <th>Name</th>
        <th>Ort</th>
        <th>Unterstützungsmaßnahmen</th>
        <th>Anmerkungen</th>
        <th>Strecke</th>
        <th>Zeit</th>
        <th>Km</th>
        <th>Aktion</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<div id="summenAnzeige" class="summary"></div>
<div id="berichte"></div>
<button id="openExportDialogZeit">Exportieren (Tätigkeitsbericht)</button>
<button id="openExportDialogKm">Exportieren (Fahrtkostenabrechnung)</button>
<button id="backupBtn" class="data-btn">Datensätze sichern</button>
<input type="file" id="restoreInput" style="display:none" />
<button id="restoreBtn" class="data-btn">Datensätze laden</button>
<button id="deleteAllBtn" class="cancel-btn">Alle Datensätze löschen</button>
</div>

<!-- Export Modals -->
<div id="exportDialogZeit" class="modal">
<h2>Tätigkeitsbericht</h2>
<form>
<div class="form-group"><label>Monat:</label><input type="text" id="monatZeit" required></div>
<div class="form-group"><label>Datum:</label><input type="date" id="datumZeit" required></div>
<div class="form-group"><label>Bereichslehrkraft:</label><input type="text" id="bereichslehrkraftZeit" required></div>
<button type="button" id="exportPdfZeit">Speichern als PDF</button>
<button type="button" id="exportCsvZeit">Speichern als CSV</button>
<button type="button" id="exportXlsZeit">Speichern als Excel</button>
<button type="button" id="cancelExportZeit" class="cancel-btn">Abbrechen</button>
</form>
</div>

<div id="exportDialogKm" class="modal">
<h2>Fahrtkostenabrechnung</h2>
<form>
<div class="form-group"><label>Monat:</label><input type="text" id="monatKm" required></div>
<div class="form-group"><label>Datum:</label><input type="date" id="datumKm" required></div>
<div class="form-group"><label>Bereichslehrkraft:</label><input type="text" id="bereichslehrkraftKm" required></div>
<button type="button" id="exportPdfKm">Speichern als PDF</button>
<button type="button" id="exportCsvKm">Speichern als CSV</button>
<button type="button" id="exportXlsKm">Speichern als Excel</button>
<button type="button" id="cancelExportKm" class="cancel-btn">Abbrechen</button>
</form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);
  const showMessage = msg => { 
    const el = document.createElement('div'); 
    el.textContent = msg; 
    el.style.position = 'fixed'; 
    el.style.top = '10px'; 
    el.style.left = '50%'; 
    el.style.transform = 'translateX(-50%)'; 
    el.style.background = '#27ae60'; 
    el.style.color = 'white'; 
    el.style.padding = '10px 20px'; 
    el.style.borderRadius = '6px'; 
    el.style.zIndex = '2000'; 
    document.body.appendChild(el); 
    setTimeout(() => el.remove(), 2000); 
  };

  const normalizeTaetigkeit = t => {
    if (Array.isArray(t)) return t;
    if (!t) return [];
    return String(t).split(/[,;]+/).map(s => s.trim()).filter(Boolean);
  };

function isDuplicate(ds, originalIndex) {
  return dataSets.some((other, idx) => {
    if (idx === originalIndex) return false;
    return ds.datum === other.datum &&
           ds.name === other.name &&
           ds.schule === other.schule &&
           JSON.stringify(normalizeTaetigkeit(ds.tatigkeit)) === JSON.stringify(normalizeTaetigkeit(other.tatigkeit)) &&
           ds.anmerkungen === other.anmerkungen &&
           ds.strecke === other.strecke &&
           ds.zeit === other.zeit &&
           ds.km === other.km;
  });
}

  let dataSets = [];
  let sortAsc = true;
  const formatDateGerman = s => { if(!s) return ''; const d = new Date(s); return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; };
  const sumByKey = (data, key) => data.reduce((a, ds) => a + (+ds[key]||0), 0);

// Statt:
// const monthMap = { "Januar":0, "Februar":1, "März":2, "April":3, "Mai":4, "Juni":5, "Juli":6, "August":7, "September":8, "Oktober":9, "November":10, "Dezember":11 };

// Verwenden wir ein Array für konsistente Monatsnamen
const monthNames = [
  "Januar","Februar","März","April","Mai","Juni",
  "Juli","August","September","Oktober","November","Dezember"
];

const monthMap = monthNames.reduce((acc, name, idx) => { acc[name] = idx; return acc; }, {});

const filterByMonth = (data, monthText) => { 
  const [monthName, yearText] = monthText.trim().split(/\s+/); 
  const monthNum = monthMap[monthName]; 
  const yearNum = parseInt(yearText, 10); 
  if(monthNum === undefined || isNaN(yearNum)) return []; 
  return data.filter(ds => { 
    const d = new Date(ds.datum); 
    return d.getMonth() === monthNum && d.getFullYear() === yearNum; 
  }); 
};

const getCurrentMonthYear = () => {
  const today = new Date();
  return `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
};

document.getElementById("sortDateHeader").onclick = () => {
  sortAsc = !sortAsc;
  document.getElementById("sortDateHeader").textContent = sortAsc ? "Datum ↑" : "Datum ↓";
  updateTable(document.getElementById("searchInput").value);
};

  // Daten laden
  function loadData() {
    const saved = localStorage.getItem('dataSets');
    if(saved) { 
      dataSets = JSON.parse(saved); 
      dataSets.forEach(ds => ds.tatigkeit = normalizeTaetigkeit(ds.tatigkeit));
      updateTable(); 
    }
  }

  // Backup/Restore
  $('restoreBtn').onclick = () => $('restoreInput').click();
  $('restoreInput').onchange = e => {
    const file=e.target.files[0];
    if(file){
      const reader=new FileReader();
      reader.onload = evt=>{
        try {
          const imported=JSON.parse(evt.target.result);
          imported.forEach(ds => ds.tatigkeit = normalizeTaetigkeit(ds.tatigkeit));
          dataSets=imported;
          localStorage.setItem("dataSets",JSON.stringify(dataSets));
          updateTable();
          showMessage("Datensätze erfolgreich geladen!");
        } catch(err){ alert("Fehler beim Laden: "+err); }
      };
      reader.readAsText(file);
    }
  };

// Alle Datensätze löschen
$('deleteAllBtn').onclick = () => {
  if (confirm("Alle Datensätze wirklich löschen? Diese Aktion kann nicht rückgängig gemacht werden!")) {
    dataSets = []; // Array leeren
    localStorage.removeItem("dataSets"); // LocalStorage löschen
    updateTable(); // Tabelle neu rendern
    showMessage("Alle Datensätze wurden gelöscht!");
  }
};

  // Form Submission
$('dataForm').onsubmit = e => {
    e.preventDefault();

    const ds = {
      datum: $('datum').value,
      name: $('name').value,
      schule: $('schule').value,
      tatigkeit: Array.from($('tatigkeit').selectedOptions).map(o=>o.value),
      anmerkungen: $('anmerkungen').value,
      strecke: $('strecke').value,
      zeit: parseFloat($('zeit').value)||0,
      km: parseFloat($('km').value)||0
    };

    // Dublettenerkennung
    if (isDuplicate(ds, e.target.dataset.editIndex !== undefined ? +e.target.dataset.editIndex : -1)) {
      if (!confirm("Achtung: Dieser Datensatz scheint ein Duplikat zu sein. Trotzdem speichern?")) {
        return;
      }
    }

    if (e.target.dataset.editIndex !== undefined) {
      dataSets[e.target.dataset.editIndex] = ds;
      showMessage("Datensatz erfolgreich bearbeitet!");
    } else {
      dataSets.push(ds);
      showMessage("Datensatz erfolgreich hinzugefügt!");
    }

    localStorage.setItem("dataSets", JSON.stringify(dataSets));
    updateTable();

    // **Formular jetzt sauber zurücksetzen**
    delete e.target.dataset.editIndex; // Bearbeitungsmodus beenden **vor** reset
    e.target.reset();                  // Felder leeren
    $('datum').valueAsDate = new Date(); // Datum auf heute
    $('submitBtn').textContent = "Datensatz hinzufügen"; // Button zurücksetzen
};

// Hilfsfunktion: prüft, ob ein Datensatz doppelt ist
function updateTable(filter="") {
  const tbody = $("tableBody");
  tbody.innerHTML = "";

  dataSets
    .filter(ds => Object.values(ds).some(v => JSON.stringify(v).toLowerCase().includes(filter.toLowerCase())))
    .sort((a, b) => sortAsc ? new Date(a.datum) - new Date(b.datum) : new Date(b.datum) - new Date(a.datum))
    .forEach(ds => {
      const tr = document.createElement("tr");

      // Originalindex im dataSets-Array
      const originalIndex = dataSets.findIndex(d => d === ds);

      // Duplikat markieren
      if (isDuplicate(ds, originalIndex)) {
        tr.style.backgroundColor = "#ffe6e6";
        tr.title = "Möglicher doppelter Eintrag!";
      }

      // Tabellenzeile
      tr.innerHTML = `
        <td>${formatDateGerman(ds.datum)}</td>
        <td>${ds.name}</td>
        <td>${ds.schule}</td>
        <td>${Array.isArray(ds.tatigkeit) ? ds.tatigkeit.join(", ") : ds.tatigkeit}</td>
        <td>${ds.anmerkungen}</td>
        <td>${ds.strecke}</td>
        <td>${ds.zeit}</td>
        <td>${ds.km}</td>
        <td>
          <button class="edit-btn" data-index="${originalIndex}">Bearbeiten</button>
          <button class="copy-btn" data-index="${originalIndex}">Kopieren</button>
          <button class="delete-btn" data-index="${originalIndex}">Löschen</button>
        </td>
      `;

      tbody.appendChild(tr);
    });

  // Buttons wieder korrekt zuweisen
  document.querySelectorAll(".edit-btn").forEach(btn => {
    btn.onclick = () => editRecord(parseInt(btn.dataset.index));
  });
  document.querySelectorAll(".copy-btn").forEach(btn => {
    btn.onclick = () => copyRecord(parseInt(btn.dataset.index));
  });
  document.querySelectorAll(".delete-btn").forEach(btn => {
    btn.onclick = () => deleteRecord(parseInt(btn.dataset.index));
  });

  updateSummary();
}

// --- Neue Funktion: Summen unter der Tabelle anzeigen ---
function updateSummary() { 
    const totalZeit = dataSets.reduce((sum, ds) => sum + (+ds.zeit || 0), 0);
    const totalKm = dataSets.reduce((sum, ds) => sum + (+ds.km || 0), 0);

    // --- Summen für alle vorhandenen Monate ---
    const monthGroups = {};
    dataSets.forEach(ds => {
        const d = new Date(ds.datum);
        const key = `${monthNames[d.getMonth()]} ${d.getFullYear()}`;

        if (!monthGroups[key]) monthGroups[key] = { entries: [], firstDate: d }; // erstes Datum merken
        monthGroups[key].entries.push(ds);
        if (d < monthGroups[key].firstDate) monthGroups[key].firstDate = d; // frühestes Datum für Sortierung
    });

    // Monate nach Datum absteigend sortieren
    const sortedMonths = Object.entries(monthGroups).sort((a, b) => b[1].firstDate - a[1].firstDate);

    let monthSummaryText = '';
    sortedMonths.forEach(([monthName, data]) => {
        const sumZeit = data.entries.reduce((sum, ds) => sum + (+ds.zeit || 0), 0);
        const sumKm = data.entries.reduce((sum, ds) => sum + (+ds.km || 0), 0);
        monthSummaryText += `${monthName}: ${sumZeit.toFixed(2)} h, ${sumKm.toFixed(2)} km\n`;
    });

    // Gesamtsumme + Monatsübersicht
    $('summenAnzeige').innerHTML =
        `Gesamtzeit: ${totalZeit.toFixed(2)} h, Gesamtkilometer: ${totalKm.toFixed(2)} km<br>` +
        `<strong>Alle Monate:</strong><br>` +
        monthSummaryText.replace(/\n/g, '<br>');
}

// Modal-Logik: Name übernehmen, nur wenn vorhanden
function openModal(modal) {
  if(modal.id === "exportDialogZeit") 
      $('bereichslehrkraftZeit').value = $('name').value || '';
  if(modal.id === "exportDialogKm") 
      $('bereichslehrkraftKm').value = $('name').value || '';
  
  modal.classList.add("active");
  overlay.classList.add("active");
  modal.setAttribute("role", "dialog");
  modal.setAttribute("aria-modal", "true");
}

function closeModal(modal) {
  modal.classList.remove("active");
  overlay.classList.remove("active");
}

// Beim Bearbeiten wird Name gesetzt
function editRecord(i){
    const ds=dataSets[i];
    $('datum').value=ds.datum;
    $('name').value=ds.name;
    $('schule').value=ds.schule;
    Array.from($('tatigkeit').options).forEach(o=>o.selected=normalizeTaetigkeit(ds.tatigkeit).includes(o.value));
    $('anmerkungen').value=ds.anmerkungen;
    $('strecke').value=ds.strecke;
    $('zeit').value=ds.zeit;
    $('km').value=ds.km;
    $('dataForm').dataset.editIndex=i;
    $('submitBtn').textContent="Änderungen speichern";
    window.scrollTo({top:0, behavior:'smooth'});
    showMessage("Datensatz ausgewählt – jetzt bearbeiten!");
}

  function deleteRecord(i){ if(confirm("Diesen Datensatz wirklich löschen?")){ dataSets.splice(i,1); localStorage.setItem("dataSets",JSON.stringify(dataSets)); updateTable(); showMessage("Datensatz erfolgreich gelöscht!"); } }
  function copyRecord(i){
    const copy = { ...dataSets[i] }; // Datum bleibt gleich
    dataSets.push(copy);              // Kopie ans Ende der Liste
    localStorage.setItem("dataSets", JSON.stringify(dataSets));
    updateTable();                    // Tabelle neu rendern
    const newIndex = dataSets.length - 1;
    editRecord(newIndex);             // Formular mit Kopie öffnen
    showMessage("Datensatz kopiert und zur Bearbeitung geöffnet.");
}

// PDF Export
function exportPdf(type, month, date, teacher){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:"landscape", unit:"mm", format:"a4"});

  const titles = {
    taetigkeitsbericht: "Berichtsdokument für Bereichslehrkräfte für reisende Kinder und Jugendliche",
    fahrtkostenabrechnung: "Bereichslehrkräfte für reisende Kinder und Jugendliche – Fahrtkostenabrechnung"
  };
  
  doc.setFontSize(14);
  doc.text(titles[type], 10, 15);
  doc.setFontSize(12);
  doc.text(`Monat: ${month}`, 10, 30);
  doc.text(`Datum: ${formatDateGerman(date)}`, 10, 40);
  doc.text(`Bereichslehrkraft: ${teacher}`, 10, 50);
  doc.text(`Unterschrift: gez. ${teacher}`, 150, 50);

  let filtered = filterByMonth(dataSets, month);
  if(type === "fahrtkostenabrechnung") filtered = filtered.filter(ds => ds.km && ds.km > 0);
  // Nach Datum sortieren
  filtered = filtered.sort((a, b) => new Date(a.datum) - new Date(b.datum));

  let head, body;
  if(type === "taetigkeitsbericht"){
    head = [["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke","Zeit (h)"]];
    body = filtered.map(ds => [
      formatDateGerman(ds.datum),
      ds.name,
      ds.schule,
      normalizeTaetigkeit(ds.tatigkeit).map(t => "• "+t).join("\n"),
      ds.anmerkungen,
      ds.strecke,
      ds.zeit.toFixed(2).replace(/\.00$/, '')
    ]);
  } else {
    head = [["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke","Km"]];
    body = filtered.map(ds => [
      formatDateGerman(ds.datum),
      ds.name,
      ds.schule,
      normalizeTaetigkeit(ds.tatigkeit).map(t => "• "+t).join("\n"),
      ds.anmerkungen,
      ds.strecke,
      ds.km.toFixed(2).replace(/\.00$/, '')
    ]);
  }

  doc.autoTable({
    startY: 60,
    head: head,
    body: body,
    theme: "grid",
    styles: { fontSize: 12 },
    columnStyles: {
      0: { cellWidth: 25 },  // Datum – etwas breiter
      1: { cellWidth: 40 },  // Name – schmaler
      2: { cellWidth: 40 },  // Ort
      3: { cellWidth: 70 },  // Unterstützungsmaßnahmen – breit
      4: { cellWidth: 50 },  // Anmerkungen – breit
      5: { cellWidth: 25 },  // Strecke – schmal
      6: { cellWidth: 18 }   // Zeit oder Km
    },
    didDrawPage: function(data){
      const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;
      doc.setFontSize(10);
      doc.text(`Seite ${pageNumber}`, data.settings.margin.left, doc.internal.pageSize.getHeight() - 10);
    }
  });

  const finalY = doc.lastAutoTable.finalY + 5;
  const sumZeit = sumByKey(filtered,"zeit").toFixed(2).replace(/\.00$/, '');
  const sumKm = sumByKey(filtered,"km").toFixed(2).replace(/\.00$/, '');

  doc.setFont(undefined,"bold");
  const pageWidth = doc.internal.pageSize.getWidth();
  const offsetRight = 20;
  if(type === "taetigkeitsbericht") doc.text(`Gesamtzeit: ${sumZeit}`, pageWidth - offsetRight, finalY, {align:"right"});
  if(type === "fahrtkostenabrechnung") doc.text(`Gesamtkilometer: ${sumKm}`, pageWidth - offsetRight, finalY, {align:"right"});
  doc.setFont(undefined,"normal");

  doc.save(`${type}_${month}_${teacher}.pdf`.replace(/\s+/g,"_"));
}

// CSV / Excel Export
function exportTable(type, month, date, teacher, format){
  let filtered = filterByMonth(dataSets, month);
  if(type === "fahrtkostenabrechnung") filtered = filtered.filter(ds => ds.km && ds.km > 0);
  // Nach Datum sortieren
  filtered = filtered.sort((a, b) => new Date(a.datum) - new Date(b.datum));

  const headerLines = [
    [`${type==="taetigkeitsbericht" ? 
       "Berichtsdokument für Bereichslehrkräfte für reisende Kinder und Jugendliche" :
       "Bereichslehrkräfte für reisende Kinder und Jugendliche – Fahrtkostenabrechnung"}`],
    [`Monat: ${month}`],
    [`Datum: ${formatDateGerman(date)}`],
    [`Bereichslehrkraft: ${teacher}`],
    []
  ];

  const rows = filtered.map(ds => {
    const base = [
      formatDateGerman(ds.datum),
      ds.name,
      ds.schule,
      normalizeTaetigkeit(ds.tatigkeit).map(t=>"• "+t).join("\n"),
      ds.anmerkungen,
      ds.strecke
    ];
    if(type==="taetigkeitsbericht") base.push(ds.zeit);
    else base.push(ds.km);
    return base;
  });

  const head = ["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke"];
  if(type==="taetigkeitsbericht") head.push("Zeit");
  else head.push("Km");

  const sumValue = type==="taetigkeitsbericht" ? sumByKey(filtered,"zeit") : sumByKey(filtered,"km");
  const sumRow = head.map(h => {
    let sumValue = 0;
    if(h==="Zeit" && type==="taetigkeitsbericht") sumValue = sumByKey(filtered,"zeit");
    if(h==="Km" && type==="fahrtkostenabrechnung") sumValue = sumByKey(filtered,"km");
    if(sumValue){
        let val = sumValue.toFixed(2);
        if(val.endsWith("00")) val = val.slice(0,-3);
        return val;
    }
    return "";
  });

  if(format === "csv"){
    let csvContent = "\uFEFF";
    headerLines.forEach(line=>{
      csvContent += line.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(";") + "\n";
    });
    csvContent += head.map(cell => `"${cell}"`).join(";") + "\n";
    rows.forEach(row => {
      csvContent += row.map((cell, index) => {
        // Wenn es die Zeit- oder Km-Spalte ist, Dezimalpunkt in Komma ändern
        if((type === "taetigkeitsbericht" && head[index] === "Zeit") ||
           (type === "fahrtkostenabrechnung" && head[index] === "Km")) {
          if(cell != null && cell !== "") {
              let val = Number(cell).toFixed(2);        // 2 Dezimalstellen
              if(val.endsWith("00")) val = val.slice(0,-3); // .00 entfernen
              return `"${val.replace(".", ",")}"`;
          }
          return '""';
        }
        return `"${String(cell).replace(/"/g,'""')}"`;
      }).join(";") + "\n";
    });
    csvContent += sumRow.map(cell=>`"${cell}"`).join(";") + "\n";

    const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${type}_${month}_${teacher}.csv`.replace(/\s+/g,"_");
    a.click();
  }

  else if(format==="xls"){
    const wb = XLSX.utils.book_new();
    const ws_data = headerLines.concat([head]).concat(rows);
    ws_data.push(sumRow);

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    ws['!cols'] = [
      {wch:12},
      {wch:20},
      {wch:25},
      {wch:40},
      {wch:20},
      {wch:20},
      {wch:10}
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Export");
    XLSX.writeFile(wb, `${type}_${month}_${teacher}.xlsx`.replace(/\s+/g,"_"));
  }
}

  // Event Handler Export, Backup, Search
  $('exportPdfZeit').onclick = () => { exportPdf("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value); };
  $('exportCsvZeit').onclick = () => { exportTable("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value,"csv"); };
  $('exportXlsZeit').onclick = () => { exportTable("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value,"xls"); };

  $('exportPdfKm').onclick = () => { exportPdf("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value); };
  $('exportCsvKm').onclick = () => { exportTable("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value,"csv"); };
  $('exportXlsKm').onclick = () => { exportTable("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value,"xls"); };

  $('backupBtn').onclick = () => { 
    const blob=new Blob([JSON.stringify(dataSets)],{type:"application/json"});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='data_backup.json';
    a.click();
  };

  $('searchInput').addEventListener("input", updateTable);

  // Modal-Logik
const overlay = document.getElementById("modalOverlay");

  $('openExportDialogZeit').onclick = () => openModal($('exportDialogZeit'));
  $('cancelExportZeit').onclick = () => closeModal($('exportDialogZeit'));
  $('openExportDialogKm').onclick = () => openModal($('exportDialogKm'));
  $('cancelExportKm').onclick = () => closeModal($('exportDialogKm'));

  overlay.onclick = () => {
    closeModal($('exportDialogZeit'));
    closeModal($('exportDialogKm'));
  };

  loadData();
});
</script>

<style>
/* ---- Handy-Optimierungen ---- */
/* ---- Handy-Optimierungen ---- */
@media (max-width:480px) {
  /* Smartphone (hochformat): gleiche Scroll-Logik + 5px Reserve damit keine Spalte zu schmal wird */
.table-scroll {
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 4px; /* verhindert abgeschnittenen Scrollbalken */
  box-sizing: border-box;
  padding-right: 6px;  /* kleine Reserve, verhindert dass Spalten 5px schmaler werden */
}
.table-scroll table {
  width: max-content;
  min-width: calc(100% + 5px); /* +5px Reserve für Hochformat (dein Wunsch) */
  table-layout: auto;
}

  /* Spaltenbreiten anpassen – Ort und Anmerkungen etwa 15% schmaler */
  table th:nth-child(3), td:nth-child(3) { width: 162px; }    /* Ort vorher 190px */
  table th:nth-child(5), td:nth-child(5) { width: 170px; }    /* Anmerkungen vorher 200px */

  /* Restliche Spalten unverändert */
  table th:nth-child(1), td:nth-child(1) { width: 70px; }     /* Datum */
  table th:nth-child(2), td:nth-child(2) { width: 100px; }    /* Name */
  table th:nth-child(4), td:nth-child(4) { width: 200px; }    /* Tätigkeiten */
  table th:nth-child(6), td:nth-child(6) { width: 50px; }     /* Strecke */
  table th:nth-child(7), td:nth-child(7) { width: 50px; }     /* Zeit */
  table th:nth-child(8), td:nth-child(8) { width: 50px; }     /* Km */
  table th:nth-child(9), td:nth-child(9) { width: 120px; }    /* Aktion */

  .tatigkeit-cell {
    font-size: 11px !important;
    line-height: 1.2 !important;
  }

  .edit-btn, .delete-btn, .copy-btn {
    font-size: 10px !important;
    padding: 4px 6px !important;
    margin-bottom: 2px !important;
    width: 100%;
    box-sizing: border-box;
  }
}

/* Collapsible Suche */
#toggleSearch {
  display: none;
  margin-bottom: 5px;
  width: 100%;
  padding: 10px;
  font-size: 16px;
  background: var(--brand);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
#searchContainer {
  overflow: hidden;
  max-height: 0;
  transition: max-height 0.3s ease;
}

/* Desktop & Tablet: Tabelle passt automatisch, Text bricht um */
/* Desktop & Tablet: Tabelle passt exakt zur Container-Breite */
@media (min-width: 481px) {
  .table-container table {
    width: 100%;         /* passt exakt zum Container */
    border-collapse: collapse;
    table-layout: auto;  /* flexible Spaltenbreiten */
  }

  th, td {
    padding: 6px 8px;       /* passend zu den Input-Feldern */
    white-space: normal;     /* Textumbruch */
    word-wrap: break-word;
    vertical-align: top;
    box-sizing: border-box;  /* padding zählt nicht zur Breite dazu */
  }

  /* Spalten proportional */
  table th:nth-child(1), td:nth-child(1) { width: 12%; }   /* Datum */
  table th:nth-child(2), td:nth-child(2) { width: 18%; }   /* Name */
  table th:nth-child(3), td:nth-child(3) { width: 20%; }   /* Ort */
  table th:nth-child(4), td:nth-child(4) { width: 25%; }   /* Tätigkeiten */
  table th:nth-child(5), td:nth-child(5) { width: 25%; }   /* Anmerkungen */
  /* restliche Spalten flexibel */
  table th:nth-child(6), td:nth-child(6),
  table th:nth-child(7), td:nth-child(7),
  table th:nth-child(8), td:nth-child(8),
  table th:nth-child(9), td:nth-child(9) { width: auto; }
}

/* Desktop-Optimierung: Tätigkeits-Spalte kompakt, Zeilen umbrechen */
@media (min-width: 769px) {
  table { table-layout: fixed; width: 100%; }
  table th:nth-child(1), table td:nth-child(1) { width: 80px; }   /* Datum */
  table th:nth-child(2), table td:nth-child(2) { width: 140px; }  /* Name */
  table th:nth-child(3), table td:nth-child(3) { width: 130px; }  /* Ort */
  table th:nth-child(4), table td:nth-child(4) { width: 250px; }  /* Tätigkeiten */
  table th:nth-child(5), table td:nth-child(5) { width: 150px; }  /* Anmerkungen */
  table th:nth-child(6), table td:nth-child(6) { width: 80px; }   /* Strecke */
  table th:nth-child(7), table td:nth-child(7) { width: 60px; }   /* Zeit */
  table th:nth-child(8), table td:nth-child(8) { width: 60px; }   /* Km */
  table th:nth-child(9), table td:nth-child(9) { width: 120px; }  /* Aktion */
}

  .tatigkeit-cell, td:nth-child(5) { white-space: normal; }

</style>

<!-- Mobiles Bottom-Menü -->
<div id="bottomMenu">
  <button onclick="scrollToSection('erfassen')">Tätigkeit</button>
  <button onclick="scrollToSection('daten')">Übersicht</button>
  <button onclick="scrollToSection('berichte')">Export</button>
</div>

<style>
@media (max-width: 768px) {
  #bottomMenu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--brand);
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 4px 0;
    border-top: 1px solid var(--brand-d);
    z-index: 3000;
  }

  #bottomMenu button {
    background: transparent;
    color: white;
    border: none;
    font-size: 14px;
    flex: 1;
    text-align: center;
    cursor: pointer;
    padding: 6px 0;
    font-weight: 500;
    letter-spacing: 0.3px;
  }

  #bottomMenu button:active {
    background: var(--brand-d);
  }

  body {
    padding-bottom: 45px;
  }
}

@media (min-width: 769px) {
  #bottomMenu { display: none !important; }
}
</style>

<script>
function scrollToSection(id) {
  const el = document.getElementById(id);
  if (!el) return;
  const yOffset = -60; // leicht angepasst, damit die Überschrift im Viewport sichtbar ist
  const y = el.getBoundingClientRect().top + window.scrollY + yOffset;
  window.scrollTo({ top: y, behavior: 'smooth' });
}
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/datenverwaltung-app/service-worker.js')
    .then(reg => {
      reg.addEventListener('updatefound', () => {
        const newWorker = reg.installing;

        newWorker.addEventListener('statechange', () => {
          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
            // Neue Version verfügbar
            showUpdateNotification(newWorker);
          }
        });
      });
    });

  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (!refreshing) {
      refreshing = true;
      backupDataSets().finally(() => window.location.reload());
    }
  });
}

// Anzeige für neue Version
function showUpdateNotification(worker) {
  const div = document.createElement('div');
  div.style.position = 'fixed';
  div.style.bottom = '20px';
  div.style.left = '50%';
  div.style.transform = 'translateX(-50%)';
  div.style.background = '#27ae60';
  div.style.color = 'white';
  div.style.padding = '12px 20px';
  div.style.borderRadius = '8px';
  div.style.zIndex = 3000;
  div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
  div.style.cursor = 'pointer';
  div.textContent = 'Neue Version verfügbar – klicken zum Aktualisieren';
  
  div.onclick = () => {
    worker.postMessage({ action: 'skipWaiting' });
    div.remove();
  };
  
  document.body.appendChild(div);
}

// Optional: Backup vor Reload
async function backupDataSets() {
  const data = localStorage.getItem('dataSets');
  if (!data) return;

  return new Promise((resolve, reject) => {
    const request = indexedDB.open('AppBackupDB', 1);
    request.onupgradeneeded = e => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains('backup')) {
        db.createObjectStore('backup');
      }
    };
    request.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('backup', 'readwrite');
      const store = tx.objectStore('backup');
      store.put(data, 'dataSets');
      tx.oncomplete = () => resolve();
      tx.onerror = err => reject(err);
    };
    request.onerror = err => reject(err);
  });
}
</script>

</body>
</html>
