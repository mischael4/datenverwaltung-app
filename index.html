<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Datenverwaltung - Bereichslehrkräfte Köln</title>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<style>
:root { --brand:#27ae60; --brand-d:#1f8a4e; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:20px; background:#f9f9f9; color:#222; }
h2 { font-size:22px; color:var(--brand); margin-bottom:10px; }
h4 { font-size:16px; color:#333; margin-bottom:15px; }
.container { display:flex; flex-direction:column; gap:20px; max-width:1200px; margin:auto; }
.form-container, .table-container {
  background:white; border:1px solid #ddd; padding:20px; border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.05);
}
.form-group { margin-bottom:15px; }
label { display:block; margin-bottom:5px; font-weight:600; color:#555; }
label .hint { font-size:12px; font-weight:normal; color:#999; display:block; margin-top:2px; }
input,textarea,select { width:100%; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; background:#fafafa; transition: all 0.2s; }
input:focus, textarea:focus, select:focus { border-color:var(--brand); outline:none; background:white; }

button { background:var(--brand); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-size:16px; transition: all 0.2s; width:100%; display:block; margin-bottom:10px; }
button:hover { background:var(--brand-d); }
button.cancel-btn { background:#e74c3c; }
button.cancel-btn:hover { background:#c0392b; }
button.data-btn { background:#7f8c8d; }
button.data-btn:hover { background:#636e72; }

table { width:100%; border-collapse:collapse; margin-top:20px; font-size:14px; }
th,td { border:1px solid #eee; padding:10px; text-align:left; vertical-align:top; }
th { background:#f1f1f1; font-weight:600; color:#333; }
tr:nth-child(even){ background:#fcfcfc; }
.summary { margin-top:10px; margin-bottom:15px; font-weight:bold; text-align:right; color:#444; font-size:13px; }
.edit-btn { background:#f39c12; padding:4px 6px; font-size:12px; margin-bottom:4px; width:75%; }
.edit-btn:hover { background:#d68910; }
.delete-btn { background:#e74c3c; padding:4px 6px; font-size:12px; width:75%; }
.delete-btn:hover { background:#c0392b; }
.modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:25px; border:1px solid #ccc; border-radius:12px; z-index:1000; width:min(700px,90vw); max-height:90vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
@media (max-width:768px) {
  body { margin:10px; font-size:16px; }
  .form-container, .table-container { padding:15px; }
  input,textarea,button { font-size:16px; }
  button { width:100%; padding:14px; font-size:18px; }
  table { display:block; overflow-x:auto; white-space:nowrap; }
  th,td { font-size:14px; padding:6px; }
}
#tatigkeit { height:260px; font-size:13px; line-height:1.4; padding:6px; border-radius:6px; }
#tatigkeit option { padding:4px 6px; border-bottom:1px solid #eee; }
#tatigkeit option:last-child { border-bottom:none; }
</style>
</head>
<body>
<div class="container">
  <h2>Datenverwaltung - Bereichslehrkräfte Köln</h2>

  <!-- Formular -->
  <div class="form-container">
    <h4>Neuen Datensatz hinzufügen</h4>
    <form id="dataForm">
      <div class="form-group"><label for="datum">Datum:</label><input type="date" id="datum" required></div>
      <div class="form-group"><label for="name">Name:</label><input type="text" id="name" required></div>
      <div class="form-group"><label for="schule">Ort der Beschulung/ Besprechung:</label><input type="text" id="schule" required></div>
      <div class="form-group">
        <label for="tatigkeit">Unterstützungsmaßnahmen <span class="hint">(Mehrfachauswahl mit STRG/CMD)</span></label>
        <select id="tatigkeit" multiple required>
          <option>Förderunterricht</option>
          <option>Anmeldung durchreisender SchülerInnen an örtlichen Stammschulen</option>
          <option>Beratung von Bereichslehrkräften</option>
          <option>Beratung einer Stamm- oder Stützpunktschule</option>
          <option>Beratung von Eltern, Kindern und Schulen</option>
          <option>Beratung von Lehrkräften</option>
          <option>Beratung zur schulischen Perspektive</option>
          <option>Datenerfassung DigLu - Anmeldung, Aktualisierung, Pflege und Registrierung</option>
          <option>Dienstbesprechung bei der Bezirksregierung</option>
          <option>Dienstbesprechung</option>
          <option>Dokumentation</option>
          <option>Entwicklung und Mitwirkung an innovativen Unterrichtsverfahren</option>
          <option>geregelte Übergabe von SchülerInnen an andere Schulen und Bereichslehrkräfte</option>
          <option>Herstellung von Kontakten zwischen Eltern und Schulen</option>
          <option>Kontrolle der Lernstandsberichte, Einträge Schultagebuch (DigLu)</option>
          <option>Organisation von Medien und Unterrichtsmaterialien für den Online-Unterricht</option>
          <option>Organisation von Medien und Unterrichtsmaterialien für die Reise</option>
          <option>Sammlung und Entwicklung von Unterrichtsmaterial</option>
          <option>Sprechstundenbereitschaft</option>
          <option>Teilnahme an der BuFo für BLK</option>
          <option>Teilnahme BLK Landestreffen</option>
          <option>terminliche Koordination</option>
          <option>Unterstützung von SchülerInnen bei der Vorbereitung auf zentrale Prüfungen</option>
          <option>Vorbereitung der Stützpunktschulen auf den Schulbesuch</option>
          <option>besondere Koordinatorentätigkeiten</option>
          <option>sonstiges</option>
          <option>erkrankt</option>
        </select>
      </div>
      <div class="form-group"><label for="anmerkungen">Anmerkungen:</label><textarea id="anmerkungen" rows="3"></textarea></div>
      <div class="form-group"><label for="strecke">Strecke:</label><input type="text" id="strecke"></div>
      <div class="form-group"><label for="zeit">Zeit (h):</label><input type="number" id="zeit" step="0.1" required></div>
      <div class="form-group"><label for="km">Kilometer (km):</label><input type="number" id="km" step="0.1" required></div>
      <button type="submit" id="submitBtn">Datensatz hinzufügen</button>
    </form>
  </div>

  <!-- Tabelle -->
  <div class="table-container">
    <h2>Datensätze</h2>
    <table>
      <thead>
        <tr>
          <th>Datum</th><th>Name</th><th>Ort</th><th>Unterstützungsmaßnahmen</th>
          <th>Anmerkungen</th><th>Strecke</th><th>Zeit</th><th>Km</th><th>Aktion</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div id="summenAnzeige" class="summary"></div>
    <button id="openExportDialogZeit">Exportieren (Tätigkeitsbericht)</button>
    <button id="openExportDialogKm">Exportieren (Fahrtkostenabrechnung)</button>
    <button id="backupBtn" class="data-btn">Datensätze sichern</button>
    <input type="file" id="restoreInput" style="display:none" />
    <button id="restoreBtn" class="data-btn">Datensätze laden</button>
  </div>
</div>

<!-- PDF-Export Modals -->
<div id="exportDialogZeit" class="modal">
  <h2>Exportieren (Tätigkeitsbericht)</h2>
  <form>
    <div class="form-group"><label>Monat:</label><input type="text" id="monatZeit" required></div>
    <div class="form-group"><label>Datum:</label><input type="date" id="datumZeit" required></div>
    <div class="form-group"><label>Bereichslehrkraft:</label><input type="text" id="bereichslehrkraftZeit" required></div>
    <button type="button" id="exportPdfZeit">Als PDF</button>
    <button type="button" id="cancelExportZeit" class="cancel-btn">Abbrechen</button>
  </form>
</div>

<div id="exportDialogKm" class="modal">
  <h2>Exportieren (Fahrtkostenabrechnung)</h2>
  <form>
    <div class="form-group"><label>Monat:</label><input type="text" id="monatKm" required></div>
    <div class="form-group"><label>Datum:</label><input type="date" id="datumKm" required></div>
    <div class="form-group"><label>Bereichslehrkraft:</label><input type="text" id="bereichslehrkraftKm" required></div>
    <button type="button" id="exportPdfKm">Als PDF</button>
    <button type="button" id="cancelExportKm" class="cancel-btn">Abbrechen</button>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  const $=id=>document.getElementById(id);
  let dataSets=[];
  const formatDateGerman=s=>{ const d=new Date(s); return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`; };
  const sumByKey=(data,key)=>data.reduce((a,ds)=>a+(+ds[key]||0),0);
  const filterByMonth=(data,month)=>data.filter(ds=>new Date(ds.datum).toLocaleString('de-DE',{month:'long',year:'numeric'}).toLowerCase().trim()===month.toLowerCase().trim());
  const getCurrentMonthYear=()=>new Date().toLocaleString('de-DE',{month:'long',year:'numeric'});

  $('datum').valueAsDate = new Date();
  $('monatZeit').value = $('monatKm').value = getCurrentMonthYear();

  function loadData(){ const saved=localStorage.getItem('dataSets'); if(saved){ dataSets=JSON.parse(saved); updateTable(); } }
  function saveData(){ localStorage.setItem('dataSets',JSON.stringify(dataSets)); }

  $('dataForm').onsubmit=e=>{
    e.preventDefault();
    const ds={
      datum:$('datum').value, name:$('name').value, schule:$('schule').value,
      tatigkeit:Array.from($('tatigkeit').selectedOptions).map(o=>o.value).join(", "),
      anmerkungen:$('anmerkungen').value, strecke:$('strecke').value,
      zeit:$('zeit').value, km:$('km').value
    };
    if(e.target.dataset.editIndex!==undefined){ dataSets[e.target.dataset.editIndex]=ds; delete e.target.dataset.editIndex; $('submitBtn').textContent="Datensatz hinzufügen"; }
    else dataSets.push(ds);
    updateTable(); saveData(); e.target.reset(); $('datum').valueAsDate=new Date();
  };

  function updateTable(){
    $('tableBody').innerHTML='';
    dataSets.sort((a,b)=>new Date(a.datum)-new Date(b.datum));
    dataSets.forEach((ds,i)=>$('tableBody').innerHTML+=`
      <tr>
        <td>${formatDateGerman(ds.datum)}</td><td>${ds.name}</td><td>${ds.schule}</td>
        <td>${ds.tatigkeit}</td><td>${ds.anmerkungen}</td><td>${ds.strecke}</td>
        <td>${ds.zeit}</td><td>${ds.km}</td>
        <td><button class="edit-btn" data-i="${i}">Bearbeiten</button><button class="delete-btn" data-i="${i}">Löschen</button></td>
      </tr>`);
    document.querySelectorAll('.delete-btn').forEach(btn=>{ btn.onclick=()=>{ dataSets.splice(btn.dataset.i,1); updateTable(); saveData(); }; });
    document.querySelectorAll('.edit-btn').forEach(btn=>{ btn.onclick=()=>{ const ds=dataSets[btn.dataset.i]; $('datum').value=ds.datum; $('name').value=ds.name; $('schule').value=ds.schule; Array.from($('tatigkeit').options).forEach(opt=>opt.selected=ds.tatigkeit.split(", ").includes(opt.value)); $('anmerkungen').value=ds.anmerkungen; $('strecke').value=ds.strecke; $('zeit').value=ds.zeit; $('km').value=ds.km; $('dataForm').dataset.editIndex=btn.dataset.i; $('submitBtn').textContent="Änderungen speichern"; }; });
    $('summenAnzeige').textContent=`Gesamtsumme (alle Monate): Zeit=${sumByKey(dataSets,"zeit").toFixed(1)} h, Kilometer=${sumByKey(dataSets,"km").toFixed(1)} km`;
  }

  function exportPdf(type,month,date,teacher){
    const { jsPDF }=window.jspdf;
    const doc=new jsPDF({orientation:"landscape",unit:"mm",format:"a4"});

    const titles={
      taetigkeitsbericht:"Berichtsdokument für Bereichslehrkräfte für reisende Kinder und Jugendliche",
      fahrtkostenabrechnung:"Bereichslehrkräfte für reisende Kinder und Jugendliche – Fahrtkostenabrechnung"
    };
    doc.setFontSize(14);
    doc.text(titles[type],10,15);
    doc.setFontSize(12);
    doc.text(`Monat: ${month}`,10,30);
    doc.text(`Datum: ${formatDateGerman(date)}`,10,40);
    doc.text(`Bereichslehrkraft: ${teacher}`,10,50);
    doc.text("Unterschrift:",150,50);

    const filtered=filterByMonth(dataSets,month);
    const body=filtered.map(ds=>[
      formatDateGerman(ds.datum),
      ds.name,
      ds.schule,
      ds.tatigkeit,
      ds.anmerkungen,
      ds.strecke,
      ds.zeit,
      ds.km
    ]);

    // Tabelle
    doc.autoTable({
      startY:60,
      head:[["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke","Zeit (h)","Km"]],
      body:body,
      theme:"grid",
      styles:{fontSize:12}
    });

    // Summen berechnen
const sumZeit = sumByKey(filtered,"zeit").toFixed(1);
const sumKm   = sumByKey(filtered,"km").toFixed(1);

// Position knapp unter der Tabelle setzen
const finalY = doc.lastAutoTable.finalY + 8;
doc.setFont(undefined, "bold");

if(type==="taetigkeitsbericht"){
  doc.text(`Gesamtzeit: ${sumZeit}`, 257, finalY, { align: "right" }); // Zeit-Spalte
}
if(type==="fahrtkostenabrechnung"){
  doc.text(`Gesamtkilometer: ${sumKm}`, 279, finalY, { align: "right" });   // Km-Spalte
}

doc.setFont(undefined, "normal");


    doc.save(`${type}_${month}_${teacher}.pdf`.replace(/\s+/g,"_"));
  }

  $('openExportDialogZeit').onclick=()=>{$('exportDialogZeit').style.display="block"; $('datumZeit').valueAsDate=new Date();};
  $('cancelExportZeit').onclick=()=>{$('exportDialogZeit').style.display="none";};
  $('exportPdfZeit').onclick=()=>{ exportPdf("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value); };

  $('openExportDialogKm').onclick=()=>{$('exportDialogKm').style.display="block"; $('datumKm').valueAsDate=new Date();};
  $('cancelExportKm').onclick=()=>{$('exportDialogKm').style.display="none";};
  $('exportPdfKm').onclick=()=>{ exportPdf("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value); };

  $('backupBtn').onclick=()=>{ const a=document.createElement('a'); a.href='data:text/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(dataSets)); a.download='data_backup.json'; a.click(); };
  $('restoreBtn').onclick=()=>{$('restoreInput').click();};
  $('restoreInput').onchange=e=>{ const reader=new FileReader(); reader.onload=fe=>{ dataSets=JSON.parse(fe.target.result); updateTable(); saveData(); }; reader.readAsText(e.target.files[0]); };

  loadData(); updateTable();
});
</script>
</body>
</html>
