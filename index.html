<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Datenverwaltung - Bereichslehrkräfte Köln</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#27ae60">

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<!-- Excel/CSV -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root { --brand:#27ae60; --brand-d:#1f8a4e; }
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:20px; background:#f9f9f9; color:#222; }
h2 { font-size:22px; color:var(--brand); margin-bottom:10px; }
h4 { font-size:16px; color:#333; margin-bottom:15px; }
.container { display:flex; flex-direction:column; gap:20px; max-width:1200px; margin:auto; }
.form-container, .table-container { background:white; border:1px solid #ddd; padding:20px; border-radius:10px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
.form-group { margin-bottom:15px; }
label { display:block; margin-bottom:5px; font-weight:600; color:#555; }
label .hint { font-size:12px; font-weight:normal; color:#999; display:block; margin-top:2px; }
input,textarea,select { width:100%; padding:10px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; background:#fafafa; transition: all 0.2s; }
input:focus, textarea:focus, select:focus { border-color:var(--brand); outline:none; background:white; }

button { background:var(--brand); color:white; padding:12px; border:none; border-radius:8px; cursor:pointer; font-size:16px; transition: all 0.2s; width:100%; display:block; margin-bottom:10px; }
button:hover { background:var(--brand-d); }
button.cancel-btn { background:#e74c3c; }
button.cancel-btn:hover { background:#c0392b; }
button.data-btn { background:#7f8c8d; }
button.data-btn:hover { background:#636e72; }

table { width:100%; border-collapse:collapse; margin-top:20px; font-size:14px; }
th,td { border:1px solid #eee; padding:10px; text-align:left; vertical-align:top; }
th { background:#f1f1f1; font-weight:600; color:#333; }
tr:nth-child(even){ background:#fcfcfc; }
.tatigkeit-cell { font-size: 14px; line-height: 1.4; }
.summary { margin-top:10px; margin-bottom:15px; font-weight:bold; text-align:right; color:#444; font-size:13px; }
.edit-btn { background:#f39c12; padding:4px 6px; font-size:12px; margin-bottom:4px; width:99%; }
.edit-btn:hover { background:#d68910; }
.delete-btn { background:#e74c3c; padding:4px 6px; font-size:12px; margin-bottom:4px; width:99%; }
.delete-btn:hover { background:#c0392b; }
.copy-btn { background:#2980b9; padding:4px 6px; font-size:12px; width:99%; }
.copy-btn:hover { background:#21618c; }
.modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:25px; border:1px solid #ccc; border-radius:12px; z-index:1000; width:min(700px,90vw); max-height:90vh; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,0.1); }
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.3);
  z-index: 900;
}
.modal.active,
.modal-overlay.active {
  display: block;
}

@media (max-width:768px) {
  body { margin:10px; font-size:16px; }
  .form-container, .table-container { padding:15px; }
  input,textarea,button { font-size:16px; }
  button { width:100%; padding:14px; font-size:18px; }
  table { display:block; overflow-x:auto; white-space:nowrap; }
  th,td { font-size:14px; padding:4px 6px; line-height:1.3; }
  .tatigkeit-cell { font-size:14px !important; line-height:1.3 !important; }
}
@media (max-width:480px) {
  th, td { font-size:12px; padding:3px 5px; }
  #tatigkeit { font-size:12px; height:140px; }

  /* Neu: Buttons kompakt und automatisch in der Breite */
  .edit-btn, .delete-btn, .copy-btn {
    font-size:14px; 
    padding:4px 6px;
    width:auto;  /* statt 99% */
  }
}

#tatigkeit { height:180px; font-size:13px; line-height:1.4; padding:6px; border-radius:6px; }
#tatigkeit option { padding:4px 6px; border-bottom:1px solid #eee; }
#tatigkeit option:last-child { border-bottom:none; }
#searchInput { margin-top:10px; padding:8px; border:1px solid #ccc; border-radius:6px; }
</style>
</head>
<body>
<div class="container">
<h2>Datenverwaltung - Bereichslehrkräfte Köln</h2>

<div class="form-container">
<h4>Neuen Datensatz hinzufügen</h4>
<form id="dataForm">
<div class="form-group"><label for="datum">Datum:</label><input type="date" id="datum" required></div>
<div class="form-group"><label for="name">Name:</label><input type="text" id="name" required></div>
<div class="form-group"><label for="schule">Ort der Beschulung/ Besprechung:</label><input type="text" id="schule" required></div>
<div class="form-group">
<label for="tatigkeit">Unterstützungsmaßnahmen <span class="hint">(Mehrfachauswahl mit STRG/CMD)</span></label>
<select id="tatigkeit" multiple required>
<option>Förderunterricht</option>
<option>Anmeldung durchreisender SchülerInnen an örtlichen Stammschulen</option>
<option>Beratung von Bereichslehrkräften</option>
<option>Beratung einer Stamm- oder Stützpunktschule</option>
<option>Beratung von Eltern, Kindern und Schulen</option>
<option>Beratung von Lehrkräften</option>
<option>Beratung zur schulischen Perspektive</option>
<option>Datenerfassung DigLu - Anmeldung, Aktualisierung, Pflege und Registrierung</option>
<option>Dienstbesprechung bei der Bezirksregierung</option>
<option>Dienstbesprechung</option>
<option>Dokumentation</option>
<option>Entwicklung und Mitwirkung an innovativen Unterrichtsverfahren</option>
<option>geregelte Übergabe von SchülerInnen an andere Schulen und Bereichslehrkräfte</option>
<option>Herstellung von Kontakten zwischen Eltern und Schulen</option>
<option>Kontrolle der Lernstandsberichte, Einträge Schultagebuch (DigLu)</option>
<option>Organisation von Medien und Unterrichtsmaterialien für den Online-Unterricht</option>
<option>Organisation von Medien und Unterrichtsmaterialien für die Reise</option>
<option>Sammlung und Entwicklung von Unterrichtsmaterial</option>
<option>Sprechstundenbereitschaft</option>
<option>Teilnahme an der BuFo für BLK</option>
<option>Teilnahme BLK Landestreffen</option>
<option>terminliche Koordination</option>
<option>Unterstützung von SchülerInnen bei der Vorbereitung auf zentrale Prüfungen</option>
<option>Vorbereitung der Stützpunktschulen auf den Schulbesuch</option>
<option>besondere Koordinatorentätigkeiten</option>
<option>sonstiges</option>
<option>erkrankt</option>
</select>
</div>
<div class="form-group"><label for="anmerkungen">Anmerkungen:</label><textarea id="anmerkungen" rows="3"></textarea></div>
<div class="form-group"><label for="strecke">Strecke:</label><input type="text" id="strecke"></div>
<div class="form-group"><label for="zeit">Zeit (h):</label><input type="number" id="zeit" step="0.1" min="0" required></div>
<div class="form-group"><label for="km">Kilometer (km):</label><input type="number" id="km" step="0.1" min="0" required></div>
<button type="submit" id="submitBtn">Datensatz hinzufügen</button>
</form>
</div>

<div class="table-container">
<h2>Datensätze</h2>
<input type="text" id="searchInput" placeholder="Suche nach Text..." />
<table>
<thead>
<tr>
<th>Datum</th><th>Name</th><th>Ort</th><th>Unterstützungsmaßnahmen</th>
<th>Anmerkungen</th><th>Strecke</th><th>Zeit</th><th>Km</th><th>Aktion</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>
<div id="summenAnzeige" class="summary"></div>
<button id="openExportDialogZeit">Exportieren (Tätigkeitsbericht)</button>
<button id="openExportDialogKm">Exportieren (Fahrtkostenabrechnung)</button>
<button id="backupBtn" class="data-btn">Datensätze sichern</button>
<input type="file" id="restoreInput" style="display:none" />
<button id="restoreBtn" class="data-btn">Datensätze laden</button>
</div>

<!-- Export Modals -->
<div id="exportDialogZeit" class="modal">
<h2>Tätigkeitsbericht</h2>
<form>
<div class="form-group"><label>Monat:</label><input type="text" id="monatZeit" required></div>
<div class="form-group"><label>Datum:</label><input type="date" id="datumZeit" required></div>
<div class="form-group"><label>Bereichslehrkraft:</label><input type="text" id="bereichslehrkraftZeit" required></div>
<button type="button" id="exportPdfZeit">Als PDF</button>
<button type="button" id="exportCsvZeit">Als CSV</button>
<button type="button" id="exportXlsZeit">Als Excel</button>
<button type="button" id="cancelExportZeit" class="cancel-btn">Abbrechen</button>
</form>
</div>

<div id="exportDialogKm" class="modal">
<h2>Fahrtkostenabrechnung</h2>
<form>
<div class="form-group"><label>Monat:</label><input type="text" id="monatKm" required></div>
<div class="form-group"><label>Datum:</label><input type="date" id="datumKm" required></div>
<div class="form-group"><label>Bereichslehrkraft:</label><input type="text" id="bereichslehrkraftKm" required></div>
<button type="button" id="exportPdfKm">Als PDF</button>
<button type="button" id="exportCsvKm">Als CSV</button>
<button type="button" id="exportXlsKm">Als Excel</button>
<button type="button" id="cancelExportKm" class="cancel-btn">Abbrechen</button>
</form>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = id => document.getElementById(id);

  const showMessage = msg => { 
    const el = document.createElement('div'); 
    el.textContent = msg; 
    el.style.position = 'fixed'; 
    el.style.top = '10px'; 
    el.style.left = '50%'; 
    el.style.transform = 'translateX(-50%)'; 
    el.style.background = '#27ae60'; 
    el.style.color = 'white'; 
    el.style.padding = '10px 20px'; 
    el.style.borderRadius = '6px'; 
    el.style.zIndex = '2000'; 
    document.body.appendChild(el); 
    setTimeout(() => el.remove(), 2000); 
  };

  const normalizeTaetigkeit = t => {
    if (Array.isArray(t)) return t;
    if (!t) return [];
    return String(t).split(/[,;]+/).map(s => s.trim()).filter(Boolean);
  };

  const savedName = localStorage.getItem('lehrkraftName');
  if(savedName) $('name').value = savedName;

  let dataSets = [];

  const formatDateGerman = s => {
    if(!s) return '';
    const d = new Date(s);
    return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()}`;
  };

  const sumByKey = (data, key) => data.reduce((a, ds) => a + (+ds[key]||0), 0);

  const filterByMonth = (data, monthText) => {
    const [monthName, yearText] = monthText.trim().split(/\s+/);
    const monthNum = new Date(`${monthName} 1, ${yearText}`).getMonth();
    const yearNum = parseInt(yearText, 10);
    return data.filter(ds => {
      const d = new Date(ds.datum);
      return d.getMonth() === monthNum && d.getFullYear() === yearNum;
    });
  };

  const getCurrentMonthYear = () => new Date().toLocaleString('de-DE', {month:'long', year:'numeric'});

  // Initialwerte
const today = new Date();
$('datum').valueAsDate = today; // Formular-Datum auf heute
$('monatZeit').value = $('monatKm').value = getCurrentMonthYear(); // aktueller Monat
$('datumZeit').valueAsDate = new Date(today.getFullYear(), today.getMonth() + 1, 0); // letzter Tag dieses Monats
$('datumKm').valueAsDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);


  if(savedName) {
    $('bereichslehrkraftZeit').value = $('bereichslehrkraftKm').value = savedName;
  }

  // Daten laden
  function loadData() {
    const saved = localStorage.getItem('dataSets');
    if(saved) { 
      dataSets = JSON.parse(saved); 
      dataSets.forEach(ds => ds.tatigkeit = normalizeTaetigkeit(ds.tatigkeit));
      updateTable(); 
    }
  }

  // Backup/Restore
  $('restoreBtn').onclick = () => $('restoreInput').click();
  $('restoreInput').onchange = e => {
    const file=e.target.files[0];
    if(file){
      const reader=new FileReader();
      reader.onload = evt=>{
        try {
          const imported=JSON.parse(evt.target.result);
          imported.forEach(ds => ds.tatigkeit = normalizeTaetigkeit(ds.tatigkeit));
          dataSets=imported;
          localStorage.setItem("dataSets",JSON.stringify(dataSets));
          updateTable();
          showMessage("Datensätze erfolgreich geladen!");
        } catch(err){ alert("Fehler beim Laden: "+err); }
      };
      reader.readAsText(file);
    }
  };

  // Form Submission
  $('dataForm').onsubmit = e => {
    e.preventDefault();
    const ds = {
      datum: $('datum').value,
      name: $('name').value,
      schule: $('schule').value,
      tatigkeit: Array.from($('tatigkeit').selectedOptions).map(o=>o.value),
      anmerkungen: $('anmerkungen').value,
      strecke: $('strecke').value,
      zeit: parseFloat($('zeit').value)||0,
      km: parseFloat($('km').value)||0
    };
    localStorage.setItem('lehrkraftName', $('name').value);

    if(e.target.dataset.editIndex!==undefined){
      dataSets[e.target.dataset.editIndex] = ds;
      delete e.target.dataset.editIndex;
      $('submitBtn').textContent="Datensatz hinzufügen";
      showMessage("Datensatz erfolgreich bearbeitet!");
    } else {
      dataSets.push(ds);
      showMessage("Datensatz erfolgreich hinzugefügt!");
    }
    localStorage.setItem("dataSets",JSON.stringify(dataSets));
    updateTable();
    e.target.reset();
    $('datum').valueAsDate = new Date();
  };

  // Tabelle aktualisieren
  function updateTable() {
    const tableBody = $("tableBody");

    // älteste zuerst
dataSets.sort((a, b) => new Date(a.datum) - new Date(b.datum));


    tableBody.innerHTML = "";
    const search = $("searchInput").value.toLowerCase();
    let totalZeit = 0, totalKm = 0, filteredZeit = 0, filteredKm = 0;
    const currentMonth = getCurrentMonthYear();

    dataSets.forEach((ds, i) => {
        const dsTatigkeit = normalizeTaetigkeit(ds.tatigkeit);
        const text = [ds.datum, ds.name, ds.schule, dsTatigkeit.join(" "), ds.anmerkungen, ds.strecke, ds.zeit, ds.km].join(" ").toLowerCase();
        if (search && !text.includes(search)) return;

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${formatDateGerman(ds.datum)}</td>
            <td>${ds.name}</td>
            <td>${ds.schule}</td>
            <td class="tatigkeit-cell">${dsTatigkeit.map(t => "• " + t).join("<br>")}</td>
            <td>${ds.anmerkungen}</td>
            <td>${ds.strecke}</td>
            <td>${ds.zeit}</td>
            <td>${ds.km}</td>
            <td>
  <button class="edit-btn" data-i="${i}" title="Bearbeiten">Bearbeiten</button>
  <button class="delete-btn" data-i="${i}" title="Löschen">Löschen</button>
  <button class="copy-btn" data-i="${i}" title="Kopieren">Kopieren</button>
</td>
`;
        tableBody.appendChild(tr);

        totalZeit += ds.zeit || 0; 
        totalKm += ds.km || 0;
        const d = new Date(ds.datum);
        if (d.toLocaleString("de-DE", {month:"long", year:"numeric"}) === currentMonth) {
            filteredZeit += ds.zeit || 0; 
            filteredKm += ds.km || 0;
        }
    });

    $("summenAnzeige").innerHTML = 
        `Gesamtzeit (alle Monate): ${totalZeit.toFixed(1)} h | Gesamtkm (alle Monate): ${totalKm.toFixed(1)} km<br>` +
        `Im aktuellen Monat (${currentMonth}): ${filteredZeit.toFixed(1)} h | ${filteredKm.toFixed(1)} km`;

    document.querySelectorAll('.edit-btn').forEach(btn => { btn.onclick = () => editRecord(btn.dataset.i); });
    document.querySelectorAll('.delete-btn').forEach(btn => { btn.onclick = () => deleteRecord(btn.dataset.i); });
    document.querySelectorAll('.copy-btn').forEach(btn => { btn.onclick = () => copyRecord(btn.dataset.i); });
}

  function editRecord(i){
    const ds=dataSets[i];
    $('datum').value=ds.datum;
    $('name').value=ds.name;
    $('schule').value=ds.schule;
    Array.from($('tatigkeit').options).forEach(o=>o.selected=normalizeTaetigkeit(ds.tatigkeit).includes(o.value));
    $('anmerkungen').value=ds.anmerkungen;
    $('strecke').value=ds.strecke;
    $('zeit').value=ds.zeit;
    $('km').value=ds.km;
    $('dataForm').dataset.editIndex=i;
    $('submitBtn').textContent="Änderungen speichern";
    window.scrollTo({top:0, behavior:'smooth'});
    showMessage("Datensatz ausgewählt – jetzt bearbeiten!");
  }

  function deleteRecord(i){ if(confirm("Diesen Datensatz wirklich löschen?")){ dataSets.splice(i,1); localStorage.setItem("dataSets",JSON.stringify(dataSets)); updateTable(); showMessage("Datensatz erfolgreich gelöscht!"); } }
  function copyRecord(i){
  // Kopie erstellen, Datum auf heute setzen
  const copy = { ...dataSets[i], datum: new Date().toISOString().split("T")[0] };
  dataSets.push(copy);
  localStorage.setItem("dataSets", JSON.stringify(dataSets));
  updateTable();

  // Formular auf den kopierten Datensatz setzen
  const newIndex = dataSets.length - 1;
  editRecord(newIndex);

  showMessage("Datensatz kopiert und zur Bearbeitung geöffnet.");
}


  // PDF Export
  function exportPdf(type, month, date, teacher){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({orientation:"landscape", unit:"mm", format:"a4"});
    const titles = {
      taetigkeitsbericht: "Berichtsdokument für Bereichslehrkräfte für reisende Kinder und Jugendliche",
      fahrtkostenabrechnung: "Bereichslehrkräfte für reisende Kinder und Jugendliche – Fahrtkostenabrechnung"
    };
    doc.setFontSize(14);
    doc.text(titles[type], 10, 15);
    doc.setFontSize(12);
    doc.text(`Monat: ${month}`, 10, 30);
    doc.text(`Datum: ${formatDateGerman(date)}`, 10, 40);
    doc.text(`Bereichslehrkraft: ${teacher}`, 10, 50);
    doc.text("Unterschrift:", 150, 50);

    const filtered = filterByMonth(dataSets, month);
    let head, body;
    if(type === "taetigkeitsbericht"){
      head = [["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke","Zeit (h)"]];
      body = filtered.map(ds => [
        formatDateGerman(ds.datum),
        ds.name,
        ds.schule,
        normalizeTaetigkeit(ds.tatigkeit).map(t => "• "+t).join("\n"),
        ds.anmerkungen,
        ds.strecke,
        ds.zeit
      ]);
    } else {
      head = [["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke","Km"]];
      body = filtered.map(ds => [
        formatDateGerman(ds.datum),
        ds.name,
        ds.schule,
        normalizeTaetigkeit(ds.tatigkeit).map(t => "• "+t).join("\n"),
        ds.anmerkungen,
        ds.strecke,
        ds.km
      ]);
    }

    doc.autoTable({
      startY: 60,
      head: head,
      body: body,
      theme: "grid",
      styles: { fontSize: 12 },
      columnStyles: {
        2:{cellWidth:40}, // C
        3:{cellWidth:80}, // D
        5:{cellWidth:40}  // F
      },
      didDrawPage: function(data){
        const pageNumber = doc.internal.getCurrentPageInfo().pageNumber;
        doc.setFontSize(10);
        doc.text(`Seite ${pageNumber}`, data.settings.margin.left, doc.internal.pageSize.getHeight() - 10);
      }
    });

    const finalY = doc.lastAutoTable.finalY + 5;
    const sumZeit = sumByKey(filtered, "zeit").toFixed(1);
    const sumKm   = sumByKey(filtered, "km").toFixed(1);
    doc.setFont(undefined,"bold");
    const pageWidth = doc.internal.pageSize.getWidth();
    const offsetRight = 20;
    if(type === "taetigkeitsbericht") doc.text(`Gesamtzeit: ${sumZeit}`, pageWidth - offsetRight, finalY, {align:"right"});
    if(type === "fahrtkostenabrechnung") doc.text(`Gesamtkilometer: ${sumKm}`, pageWidth - offsetRight, finalY, {align:"right"});
    doc.setFont(undefined,"normal");

    doc.save(`${type}_${month}_${teacher}.pdf`.replace(/\s+/g,"_"));
  }

  // CSV / Excel Export
  function exportTable(type, month, date, teacher, format){
  const filtered = filterByMonth(dataSets, month);

  const headerLines = [
    [`${type==="taetigkeitsbericht" ? 
       "Berichtsdokument für Bereichslehrkräfte für reisende Kinder und Jugendliche" :
       "Bereichslehrkräfte für reisende Kinder und Jugendliche – Fahrtkostenabrechnung"}`],
    [`Monat: ${month}`],
    [`Datum: ${formatDateGerman(date)}`],
    [`Bereichslehrkraft: ${teacher}`],
    []
  ];

  // Datenzeilen: nur relevante Spalte für Zeit/Km
  const rows = filtered.map(ds => {
    const base = [
      formatDateGerman(ds.datum),
      ds.name,
      ds.schule,
      normalizeTaetigkeit(ds.tatigkeit).map(t=>"• "+t).join("\n"),
      ds.anmerkungen,
      ds.strecke
    ];
    if(type==="taetigkeitsbericht") base.push(ds.zeit); // nur Zeit
    else base.push(ds.km); // nur Km
    return base;
  });

  // Spaltenüberschriften
  const head = ["Datum","Name","Ort","Unterstützungsmaßnahmen","Anmerkungen","Strecke"];
  if(type==="taetigkeitsbericht") head.push("Zeit");
  else head.push("Km");

  // Summen
  const sumValue = type==="taetigkeitsbericht" ? sumByKey(filtered,"zeit") : sumByKey(filtered,"km");
  const sumRow = head.map(h => {
    if(h==="Zeit" && type==="taetigkeitsbericht") return sumValue;
    if(h==="Km" && type==="fahrtkostenabrechnung") return sumValue;
    return "";
  });

  if(format === "csv"){
    let csvContent = "\uFEFF"; // BOM für Umlaute
    headerLines.forEach(line=>{
      csvContent += line.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(";") + "\n";
    });
    csvContent += head.map(cell => `"${cell}"`).join(";") + "\n";
    rows.forEach(row=>{
      csvContent += row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(";") + "\n";
    });
    csvContent += sumRow.map(cell=>`"${cell}"`).join(";") + "\n";

    const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${type}_${month}_${teacher}.csv`.replace(/\s+/g,"_");
    a.click();
  }

  else if(format==="xls"){
    const wb = XLSX.utils.book_new();
    const ws_data = headerLines.concat([head]).concat(rows);
    ws_data.push(sumRow);

    const ws = XLSX.utils.aoa_to_sheet(ws_data);

    // Spaltenbreiten
    ws['!cols'] = [
      {wch:12}, // Datum
      {wch:20}, // Name
      {wch:25}, // Ort
      {wch:40}, // Unterstützungsmaßnahmen
      {wch:20}, // Anmerkungen
      {wch:20}, // Strecke
      {wch:10}  // Zeit oder Km
    ];

    XLSX.utils.book_append_sheet(wb, ws, "Export");
    XLSX.writeFile(wb, `${type}_${month}_${teacher}.xlsx`.replace(/\s+/g,"_"));
  }
}

  // Event Handler Export, Backup, Search
  $('openExportDialogZeit').onclick = () => {$('exportDialogZeit').style.display="block";};
  $('cancelExportZeit').onclick = () => {$('exportDialogZeit').style.display="none";};
  $('exportPdfZeit').onclick = () => { exportPdf("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value); };
  $('exportCsvZeit').onclick = () => { exportTable("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value,"csv"); };
  $('exportXlsZeit').onclick = () => { exportTable("taetigkeitsbericht",$('monatZeit').value,$('datumZeit').value,$('bereichslehrkraftZeit').value,"xls"); };

  $('openExportDialogKm').onclick = () => {$('exportDialogKm').style.display="block";};
  $('cancelExportKm').onclick = () => {$('exportDialogKm').style.display="none";};
  $('exportPdfKm').onclick = () => { exportPdf("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value); };
  $('exportCsvKm').onclick = () => { exportTable("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value,"csv"); };
  $('exportXlsKm').onclick = () => { exportTable("fahrtkostenabrechnung",$('monatKm').value,$('datumKm').value,$('bereichslehrkraftKm').value,"xls"); };

  $('backupBtn').onclick = () => { 
    const blob=new Blob([JSON.stringify(dataSets)],{type:"application/json"});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='data_backup.json';
    a.click();
  };

  $('searchInput').addEventListener("input", updateTable);

  loadData();
});
</script>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>

<style>
/* ---- Handy-Optimierungen ---- */
@media (max-width:480px) {
  /* Modals fullscreen und scrollbar */
  .modal {
    width: 95vw;
    height: 95vh;
    padding: 15px;
    overflow-y: auto;
  }

  /* Buttons, Inputs, Selects größer für Touch */
  button, select, input, textarea {
    font-size: 16px !important;
    padding: 14px 12px !important;
  }

  /* Tabelle scrollable & sticky header */
  table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }
  table thead th {
    position: sticky;
    top: 0;
    background: #f1f1f1;
    z-index: 10;
  }

  /* Edit/Delete/Copy Buttons kleiner */
  .edit-btn, .delete-btn, .copy-btn {
    font-size: 10px;
    padding: 6px 4px;
  }
}

/* Collapsible Suche */
#toggleSearch {
  display: none;
  margin-bottom: 5px;
  width: 100%;
  padding: 10px;
  font-size: 16px;
  background: var(--brand);
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
#searchContainer {
  transition: max-height 0.3s ease;
  overflow: hidden;
}
/* Desktop & Tablet: Tabelle passt automatisch, Text bricht um */
/* Desktop & Tablet: Tabelle passt exakt zur Container-Breite */
@media (min-width: 481px) {
  .table-container table {
    width: 100%;         /* passt exakt zum Container */
    border-collapse: collapse;
    table-layout: auto;  /* flexible Spaltenbreiten */
  }

  th, td {
    padding: 6px 8px;       /* passend zu den Input-Feldern */
    white-space: normal;     /* Textumbruch */
    word-wrap: break-word;
    vertical-align: top;
    box-sizing: border-box;  /* padding zählt nicht zur Breite dazu */
  }

  /* Spalten proportional */
  table th:nth-child(1), td:nth-child(1) { width: 12%; }   /* Datum */
  table th:nth-child(2), td:nth-child(2) { width: 18%; }   /* Name */
  table th:nth-child(3), td:nth-child(3) { width: 20%; }   /* Ort */
  table th:nth-child(4), td:nth-child(4) { width: 25%; }   /* Tätigkeiten */
  table th:nth-child(5), td:nth-child(5) { width: 25%; }   /* Anmerkungen */
  /* restliche Spalten flexibel */
  table th:nth-child(6), td:nth-child(6),
  table th:nth-child(7), td:nth-child(7),
  table th:nth-child(8), td:nth-child(8),
  table th:nth-child(9), td:nth-child(9) { width: auto; }
}

/* Desktop-Optimierung: Tätigkeits-Spalte kompakt, Zeilen umbrechen */
@media (min-width: 769px) {
  table { table-layout: fixed; width: 100%; }
  table th:nth-child(1), table td:nth-child(1) { width: 80px; }   /* Datum */
  table th:nth-child(2), table td:nth-child(2) { width: 120px; }  /* Name */
  table th:nth-child(3), table td:nth-child(3) { width: 150px; }  /* Ort */
  table th:nth-child(4), table td:nth-child(4) { width: 250px; }  /* Tätigkeiten */
  table th:nth-child(5), table td:nth-child(5) { width: 150px; }  /* Anmerkungen */
  table th:nth-child(6), table td:nth-child(6) { width: 80px; }   /* Strecke */
  table th:nth-child(7), table td:nth-child(7) { width: 60px; }   /* Zeit */
  table th:nth-child(8), table td:nth-child(8) { width: 60px; }   /* Km */
  table th:nth-child(9), table td:nth-child(9) { width: 120px; }  /* Aktion */
}

  .tatigkeit-cell, td:nth-child(5) { white-space: normal; }
}

</style>

<script>
// Collapsible Suche auf kleinen Screens
document.addEventListener('DOMContentLoaded', () => {
  const toggleBtn = document.createElement('button');
  toggleBtn.id = 'toggleSearch';
  toggleBtn.textContent = 'Suche ein-/ausblenden';
  const searchInput = document.getElementById('searchInput');
  const searchContainer = document.createElement('div');
  searchContainer.id = 'searchContainer';
  searchInput.parentNode.insertBefore(searchContainer, searchInput);
  searchContainer.appendChild(searchInput);
  searchContainer.parentNode.insertBefore(toggleBtn, searchContainer);

  toggleBtn.addEventListener('click', () => {
    searchContainer.classList.toggle('active');
  });
});
</script>

</body>
</html>
